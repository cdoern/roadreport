# Quickstart: RoadReport

**Branch**: `001-road-report-heatmap` | **Updated**: 2026-02-19

---

## Prerequisites

| Tool | Required version | Install |
|---|---|---|
| Node.js | 20 LTS or later | https://nodejs.org |
| npm | 10+ (bundled with Node 20) | — |
| Git | Any modern version | — |
| Supabase account | Free tier | https://supabase.com |
| Vercel account | Hobby (free) | https://vercel.com |

---

## 1. Clone & Install

```bash
git clone <repo-url> roadreport
cd roadreport
npm install
```

---

## 2. Set Up Supabase Project

### 2a. Create a project

1. Log in to [supabase.com](https://supabase.com) and click **New Project**.
2. Choose a name (e.g., `roadreport`), set a database password, and select the region closest to your users.
3. Wait for the project to finish initialising (~1 minute).

### 2b. Enable PostGIS

In the Supabase dashboard: **SQL Editor** → **New Query** → run:

```sql
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS pg_cron;
```

### 2c. Run the database migration

Copy the contents of `supabase/migrations/001_initial_schema.sql` into the **SQL Editor** and run it. This creates:
- `condition_reports` table with PostGIS geography column
- All required indexes (GIST spatial, btree recency, btree session_token)
- `enforce_rate_limit` BEFORE INSERT trigger
- `get_heatmap_cells` RPC function
- `increment_upvote` RPC function
- Nightly cleanup pg_cron job

### 2d. Configure Row Level Security

In **Authentication → Policies**, enable RLS on `condition_reports` and add the following policies (or run via SQL Editor):

```sql
-- Anyone can read reports
CREATE POLICY "Public read" ON condition_reports
  FOR SELECT USING (true);

-- Anyone can insert (rate-limited by trigger)
CREATE POLICY "Public insert" ON condition_reports
  FOR INSERT WITH CHECK (true);

-- Upvotes-only update (no other columns)
CREATE POLICY "Public upvote" ON condition_reports
  FOR UPDATE USING (true)
  WITH CHECK (
    upvotes IS NOT NULL
    -- Prevent any other column from being changed via client
  );
```

> **Note**: For v1, the anon key is intentionally public. RLS is the access-control layer; the anon key is not a secret.

### 2e. Copy your project credentials

From **Settings → API**:
- **Project URL** → copy as `VITE_SUPABASE_URL`
- **anon / public** key → copy as `VITE_SUPABASE_ANON_KEY`

---

## 3. Configure Environment Variables

Create `.env.local` in the project root (this file is gitignored):

```bash
VITE_SUPABASE_URL=https://your-project-ref.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here
```

Never commit `.env.local`. The `VITE_` prefix is required for Vite to inline these values at build time.

---

## 4. Run the Development Server

```bash
npm run dev
```

Open [http://localhost:5173](http://localhost:5173). The app loads with an interactive map. If location is allowed, the map centres on your position.

**Verify the setup**:
1. The map loads with an OpenStreetMap tile layer.
2. No errors in the browser console related to Supabase (a `404` from Supabase at this point means the migration hasn't been run yet).
3. Tap **Report**, fill in the form, and submit — check the Supabase dashboard **Table Editor → condition_reports** to confirm the row was inserted.

---

## 5. Run the Linter

```bash
npm run lint
```

Zero lint errors is required before any commit. The CI build on Vercel will also fail on lint errors.

---

## 6. Build for Production

```bash
npm run build
npm run preview   # preview the production build locally
```

The build output is in `dist/`. The service worker (`sw.js`) is generated by `vite-plugin-pwa` and will be present in `dist/`.

---

## 7. Deploy to Vercel

### 7a. First-time setup

```bash
npm install -g vercel
vercel login
vercel
```

Follow the prompts. Vercel auto-detects Vite and sets `npm run build` + `dist` as the build configuration.

### 7b. Set environment variables

In the [Vercel dashboard](https://vercel.com): **Project → Settings → Environment Variables**. Add:

| Name | Value | Environments |
|---|---|---|
| `VITE_SUPABASE_URL` | your Supabase project URL | Production, Preview, Development |
| `VITE_SUPABASE_ANON_KEY` | your Supabase anon key | Production, Preview, Development |

> **Gotcha**: Environment variable changes only take effect on the next deployment. Trigger a redeploy from the Vercel dashboard after adding variables.

### 7c. Verify `vercel.json` is present

The repo root must contain `vercel.json` with:

```json
{
  "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }],
  "headers": [
    {
      "source": "/sw.js",
      "headers": [
        { "key": "Cache-Control", "value": "no-cache, no-store, must-revalidate" },
        { "key": "Service-Worker-Allowed", "value": "/" }
      ]
    },
    {
      "source": "/assets/(.*)",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
      ]
    }
  ]
}
```

The rewrite ensures direct URL access (e.g., `/report`) doesn't return a 404. The `sw.js` header prevents the browser from caching a stale service worker.

### 7d. Subsequent deployments

```bash
vercel --prod
```

Or push to the `main` branch if you've connected the GitHub repo to Vercel for automatic deployments.

---

## 8. Verify PWA Install

### Android Chrome

1. Open the deployed URL in Chrome on Android.
2. After a few seconds, an **"Add to Home Screen"** banner appears at the bottom of the screen.
3. Tap the banner → the app installs as a standalone PWA.

### iOS Safari

Safari does not show an automatic install prompt. Instruct users:

1. Open the URL in Safari.
2. Tap the **Share** button (box with arrow).
3. Scroll down and tap **Add to Home Screen**.
4. Tap **Add** — the app icon appears on the home screen.

### Verify offline tile caching

1. Navigate around the map, panning and zooming your local area.
2. In Chrome DevTools → **Application → Service Workers**, click **Offline**.
3. Reload — the map should show tiles for areas you've visited (from the `osm-tiles` Workbox cache). A gray tile appears for uncached areas.

---

## 9. Free Tier Limits to Monitor

| Metric | Limit | How to monitor |
|---|---|---|
| Supabase DB size | 500 MB | Dashboard → Settings → Database |
| Supabase egress | 5 GB/month | Dashboard → Settings → Infrastructure |
| Vercel bandwidth | 100 GB/month | Vercel dashboard → Usage |

If Supabase egress approaches the limit, reduce the heatmap poll interval from 90s to 120s by updating `POLL_INTERVAL_MS` in `src/lib/constants.ts`.

---

## Common Issues

| Symptom | Likely cause | Fix |
|---|---|---|
| Map loads but heatmap is empty | Migration not run / RPC not created | Re-run `001_initial_schema.sql` in Supabase SQL Editor |
| Report submission fails silently | `VITE_SUPABASE_*` env vars not set | Check `.env.local`; restart dev server |
| 404 on direct URL in production | `vercel.json` rewrite missing | Add the rewrite rule as shown in step 7c |
| Service worker not updating | `sw.js` being cached by browser | Confirm `Cache-Control: no-store` header is set on `/sw.js` |
| Supabase project paused | Free tier pauses after 1 week of inactivity | Resume from Supabase dashboard |
| Nominatim returns 403 | Missing `User-Agent` or `Referer` header | Set `Referer: https://your-app.vercel.app` in all Nominatim fetch calls |
